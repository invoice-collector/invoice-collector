<!DOCTYPE html>
<html lang="en" data-theme="<%= theme %>">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice-Collector - <%= __('i18n.views.manage.my_collectors') %></title>
    <link rel="stylesheet" href="/views/styles/base.css">
    <link rel="stylesheet" href="/views/styles/theme.<%= theme %>.css">
    <link rel="stylesheet" href="/views/styles/datepicker.css">
    <link rel="icon" href="/views/icons/favicon.ico" type="image/x-icon">
    <script src="/views/utils/datepicker.js"></script>
</head>
<body>
    <!-- COMPANIES CONTAINER (Écran initial) -->
    <div id="companies-container" class="ic-container">
        <div class="ic-header">
            <h1 class="ic-header-title"><%= __('i18n.views.manage.add_collectors') %></h1>
            <p class="ic-header-subtitle"><%= __('i18n.views.manage.select_collector') %></p>
        </div>
        
        <!-- Champ de recherche -->
        <div class="ic-form-group" style="margin-bottom: 2rem;">
            <div style="position: relative;">
                <img src="/views/styles/icons/search.svg" alt="Search" class="ic-input-icon">
                <input 
                    type="text" 
                    id="search-collectors" 
                    class="ic-input" 
                    placeholder="<%= __('i18n.views.manage.search_placeholder') %>" 
                    style="padding-left: 3rem;"
                    oninput="filterCompanies(this.value)"
                >
            </div>
        </div>
        
        <!-- COMPANIES LIST -->
        <div class="ic-grid" id="companies-list"></div>
    </div>
    <!-- FORM CONTAINER -->
    <div id="form-container" class="ic-container ic-hidden">
        <a href="#" class="ic-back-button" onclick="event.preventDefault(); showCompanies();">
            <span class="ic-back-icon">
                <img src="/views/styles/icons/move-left.svg" alt="Back">
            </span>
            <%= __('i18n.views.manage.return') %>
        </a>
        <div class="ic-header">
            <h1 class="ic-header-title" id="form-title"><%= __('i18n.views.manage.add_collectors') %></h1>
            <p class="ic-header-subtitle" id="form-subtitle"><%= __('i18n.views.manage.connect_account') %></p>
        </div>
        <!-- Collector info -->
        <div class="ic-collector-info" id="form-collector-info">
            <img id="form-logo" src="" alt="Logo" class="ic-collector-info-logo">
            <div class="ic-collector-info-content">
                <h3 class="ic-collector-info-name" id="form-name"></h3>
                <p class="ic-collector-info-description" id="form-description"></p>
            </div>
            <span class="ic-badge ic-badge--stable" id="form-badge">Stable</span>
        </div>
        <!-- Instructions -->
        <div class="ic-alert ic-alert--info ic-hidden" id="add-credential-instructions">
            <img src="/views/styles/icons/circle-question-mark.svg" alt="Info" class="ic-alert-icon">
            <div>
                <strong><%= __('i18n.views.manage.instructions') %>:</strong>
                <p id="instructions-text"></p>
            </div>
        </div>
        <!-- Formulaire -->
        <form id="add-credential-form">
            <div id="add-credential-form-params"></div>
            <!-- Champ datepicker pour la date de début de collecte -->
            <div class="ic-form-group">
                <label class="ic-label ic-label--required"><%= __('i18n.views.manage.download_since') %></label>
                <input type="text" id="datepicker-since" name="since" class="ic-input" placeholder="<%= __('i18n.views.manage.date_placeholder') %>" required>
                <span class="ic-input-helper">
                    <%= __('i18n.views.manage.download_since_helper') %>
                </span>
            </div>
            <!-- Form error alert -->
            <div class="ic-alert ic-alert--error ic-hidden" id="form-error">
                <img src="/views/styles/icons/x.svg" alt="Error" class="ic-alert-icon">
                <div>
                    <strong><%= __('i18n.views.manage.error') %></strong> <%= __('i18n.views.manage.error_required_fields') %>
                </div>
            </div>
            <button type="submit" class="ic-button ic-button--primary" style="width: 100%;">
                <%= __('i18n.views.manage.add_collectors') %>
            </button>
        </form>
        <!-- Sketch section -->
        <div id="hit-sketch" class="ic-hidden" style="margin-top: 2rem;">
            <p style="text-align: center; color: var(--muted); margin-bottom: 1rem;">
                <%= __('i18n.views.manage.sketch') %>
            </p>
            <button id="hit-sketch-button" class="ic-button ic-button--secondary" style="width: 100%;">
                <%= __('i18n.views.manage.sketch.hit') %>
            </button>
            <div id="hit-sketch-success" class="ic-alert ic-alert--success ic-hidden" style="margin-top: 1rem;">
                <img src="/views/styles/icons/check.svg" alt="Success" class="ic-alert-icon">
                <div><%= __('i18n.views.manage.sketch.hit.done') %></div>
            </div>
        </div>
    </div>
    <!-- PROGRESS CONTAINER -->
    <div id="progress-container" class="ic-container ic-hidden">
        <!-- TITLE (à cacher quand résultat affiché) -->
        <div id="progress-loading" class="ic-text-center">
            <div class="ic-loader">
                <div class="ic-spinner ic-spinner--large"></div>
            </div>
            
            <h1 class="ic-header-title" style="margin-bottom: 0.5rem;">
                <%= __('i18n.views.manage.adding_collector') %>
            </h1>
            <p class="ic-header-subtitle" id="progress-subtitle"><%= __('i18n.views.manage.collecting_data') %></p>
        </div>
        
        <!-- PROGRESS BAR (à cacher quand résultat affiché) -->
        <div id="progress-bar-section" class="ic-progress" style="margin-top: 2rem;">
            <div class="ic-progress-label">
                <span id="progress-text"></span>
            </div>
            <div class="ic-progress-bar" id="progress-bar-container">
                <div class="ic-progress-fill" id="progress-bar" style="width: 0%"></div>
            </div>
        </div>
        
        <!-- 2FA FORM -->
        <div id="send-2fa-container" hidden>
            <form id="send-2fa-form" style="margin-top: 2rem;">
                <div class="ic-form-group">
                    <label class="ic-label ic-label--required" id="send-2fa-instructions"></label>
                    <input 
                        type="text" 
                        name="code" 
                        class="ic-input" 
                        placeholder="<%= __('i18n.views.manage.2fa.placeholder') %>"
                    >
                </div>
                <button type="submit" class="ic-button ic-button--primary" style="width: 100%;">
                    <%= __('i18n.views.manage.continue') %>
                </button>
            </form>
        </div>
        
        <!-- RESPONSE SUCCESS -->
        <div id="progress-response-success" class="progress-response" hidden>
            <div class="ic-text-center">
                <div class="ic-response-icon ic-response-icon--success">
                    <img src="/views/styles/icons/check.svg" alt="Success">
                </div>
                <h1 class="ic-header-title" style="color: var(--success); margin-bottom: 0.5rem;">
                    <%= __('i18n.views.manage.collection_complete') %>
                </h1>
                <div class="ic-badge ic-badge--stable" style="margin-bottom: 1rem;"><%= __('i18n.views.manage.successfully_collected') %></div>
                <p class="ic-header-subtitle"><%= __('i18n.views.manage.status_complete') %></p>
                <button class="ic-button ic-button--primary" onclick="closeIframe()" style="margin-top: 2rem; width: 100%;">
                    <%= __('i18n.views.manage.close') %>
                </button>
            </div>
        </div>
        
        <!-- RESPONSE UNKNOWN -->
        <div id="progress-response-unknown" class="progress-response" hidden>
            <div class="ic-text-center">
                <div class="ic-response-icon ic-response-icon--warning">
                    <img src="/views/styles/icons/circle-question-mark.svg" alt="Unknown">
                </div>
                <h1 class="ic-header-title" style="color: var(--warning); margin-bottom: 0.5rem;">
                    <%= __('i18n.views.manage.unknown') %>
                </h1>
                <p class="ic-header-subtitle"><%= __('i18n.views.manage.collecting_data') %></p>
                <button class="ic-button ic-button--primary" onclick="closeIframe()" style="margin-top: 2rem; width: 100%;">
                    <%= __('i18n.views.manage.close') %>
                </button>
            </div>
        </div>
        
        <!-- RESPONSE ERROR -->
        <div id="progress-response-error" class="progress-response" hidden>
            <div class="ic-text-center">
                <div class="ic-response-icon ic-response-icon--danger">
                    <img src="/views/styles/icons/x.svg" alt="Error">
                </div>
                <h1 class="ic-header-title" style="color: var(--danger); margin-bottom: 0.5rem;">
                    <%= __('i18n.views.manage.collection_failed') %>
                </h1>
                <p class="ic-header-subtitle" id="progress-response-error-text"></p>
                <p style="margin-top: 0.5rem; color: var(--muted);"><%= __('i18n.views.manage.status_failed') %></p>
                <button class="ic-button ic-button--primary" onclick="closeIframe()" style="margin-top: 2rem; width: 100%;">
                    <%= __('i18n.views.manage.close') %>
                </button>
            </div>
        </div>
    </div>
    <!-- CANVAS CONTAINER (plein écran) -->
    <div id="canvas-container" class="ic-canvas-fullscreen" hidden>
        <!-- Barre de menu supérieure -->
        <div class="ic-canvas-toolbar">
            <button class="ic-canvas-toolbar-back" onclick="showCompanies()">
                <img src="/views/styles/icons/move-left.svg" alt="Back">
            </button>
            <span class="ic-canvas-toolbar-icon">
                <img src="/views/styles/icons/key-round.svg" alt="Key">
            </span>
            <span class="ic-canvas-toolbar-text"><%= __('i18n.views.manage.canvas_instruction') %></span>
            <div class="ic-canvas-toolbar-actions">
                <button id="canvas-ok" class="ic-button ic-button--primary">
                    <img src="/views/styles/icons/check.svg" alt="OK" class="ic-canvas-btn-icon">
                    <span class="ic-canvas-btn-text"><%= __('i18n.views.manage.logged_in') %></span>
                </button>
                <button id="canvas-cancel" class="ic-button ic-button--ghost">
                    <img src="/views/styles/icons/x.svg" alt="Cancel" class="ic-canvas-btn-icon">
                    <span class="ic-canvas-btn-text"><%= __('i18n.views.manage.cancel') %></span>
                </button>
            </div>
        </div>
        
        <!-- Canvas -->
        <div class="ic-canvas-content">
            <canvas id="canvas" width="1280" height="720"></canvas>
        </div>
    </div>
    <!-- REQUEST COLLECTOR CONTAINER -->
    <div id="feedback-container" class="ic-container ic-hidden">
        <a href="#" class="ic-back-button" onclick="event.preventDefault(); showCompanies();">
            <span class="ic-back-icon">
                <img src="/views/styles/icons/move-left.svg" alt="Back">
            </span>
            <%= __('i18n.views.manage.return') %>
        </a>
        
        <div class="ic-header">
            <h1 class="ic-header-title"><%= __('i18n.views.manage.request_new_collector') %></h1>
        </div>
        
        <form id="feedback-form">
            <input type="text" name="type" value="new_collector" required hidden>
            
            <div class="ic-form-group">
                <label class="ic-label ic-label--required"><%= __('i18n.views.manage.website_url') %></label>
                <input type="url" name="website_url" class="ic-input" placeholder="https://example.com" required>
            </div>
            
            <div class="ic-alert ic-alert--success ic-hidden" id="feedback-response-success">
                <img src="/views/styles/icons/check.svg" alt="Success" class="ic-alert-icon">
                <div><%= __('i18n.views.manage.request_success') %></div>
            </div>
            
            <div class="ic-alert ic-alert--error ic-hidden" id="feedback-response-error">
                <img src="/views/styles/icons/x.svg" alt="Error" class="ic-alert-icon">
                <div><%= __('i18n.views.manage.request_error') %></div>
            </div>
            
            <button type="submit" class="ic-button ic-button--primary" style="width: 100%;">
                <%= __('i18n.views.manage.submit_request') %>
            </button>
        </form>
    </div>
    <!-- SCRIPT -->
    <script>
        console.log("<%= theme %>");
        const locale = "<%= locale %>";
        const i18n = {
            cantFindCollector: "<%= __('i18n.views.manage.cant_find_collector') %>",
            letUsKnow: "<%= __('i18n.views.manage.let_us_know') %>",
            requestNew: "<%= __('i18n.views.manage.request_new') %>",
            fieldsRequired: "<%= __('i18n.views.manage.fields_required') %>",
            fieldRequired: "<%= __('i18n.views.manage.field_required') %>"
        };
    </script>
    <script src="/views/proto/datepicker/datepicker.js"></script>
    <script src="/views/ui/script.js"></script>
</body>
</html>