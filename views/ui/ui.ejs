<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice-Collector - <%= __('i18n.views.manage.my_collectors') %></title>
    <link rel="stylesheet" href="/views/styles/base.css">
    <link rel="stylesheet" href="/views/styles/theme.default.css">
    <link rel="stylesheet" href="/views/styles/datepicker.css">
    <link rel="icon" href="/views/icons/favicon.ico" type="image/x-icon">
    <script src="/views/utils/datepicker.js"></script>
</head>
<body>
    <!-- COMPANIES CONTAINER (√âcran initial) -->
    <div id="companies-container" class="ic-container">
        <div class="ic-header">
            <h1 class="ic-header-title"><%= __('i18n.views.manage.add_collectors') %></h1>
            <p class="ic-header-subtitle">S√©lectionnez un collecteur pour commencer</p>
        </div>
        
        <!-- Champ de recherche -->
        <div class="ic-form-group" style="margin-bottom: 2rem;">
            <div style="position: relative;">
                <span style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--muted);">üîç</span>
                <input 
                    type="text" 
                    id="search-collectors" 
                    class="ic-input" 
                    placeholder="Rechercher un collecteur..." 
                    style="padding-left: 3rem;"
                    oninput="filterCompanies(this.value)"
                >
            </div>
        </div>
        
        <!-- COMPANIES LIST -->
        <div class="ic-grid" id="companies-list"></div>
    </div>

    <!-- FORM CONTAINER -->
    <div id="form-container" class="ic-container ic-hidden">
        <a href="#" class="ic-back-button" onclick="event.preventDefault(); showCompanies();">
            <%= __('i18n.views.manage.return') %>
        </a>

        <div class="ic-header">
            <h1 class="ic-header-title" id="form-title"><%= __('i18n.views.manage.add_collectors') %></h1>
            <p class="ic-header-subtitle" id="form-subtitle">Connectez votre compte pour commencer √† collecter les factures</p>
        </div>

        <!-- Collector info -->
        <div class="ic-collector-info" id="form-collector-info">
            <img id="form-logo" src="" alt="Logo" class="ic-collector-info-logo">
            <div class="ic-collector-info-content">
                <h3 class="ic-collector-info-name" id="form-name"></h3>
                <p class="ic-collector-info-description" id="form-description"></p>
            </div>
            <span class="ic-badge ic-badge--stable" id="form-badge">Stable</span>
        </div>

        <!-- Instructions -->
        <div class="ic-alert ic-alert--info ic-hidden" id="add-credential-instructions">
            <span>‚Ñπ</span>
            <div>
                <strong><%= __('i18n.views.manage.instructions') %>:</strong>
                <p id="instructions-text"></p>
            </div>
        </div>

        <!-- Formulaire -->
        <form id="add-credential-form">
            <div id="add-credential-form-params"></div>

            <!-- Champ datepicker pour la date de d√©but de collecte -->
            <div class="ic-form-group">
                <label class="ic-label ic-label--required">Download Invoices Since</label>
                <input type="text" id="datepicker-since" name="since" class="ic-input" placeholder="jj / mm / aaaa" required>
                <span class="ic-input-helper">
                    Choose a date to start collecting invoices from.
                </span>
            </div>

            <div class="ic-alert ic-alert--error ic-hidden" id="form-error">
                <span>‚úï</span>
                <div>
                    <strong>Erreur</strong> Veuillez remplir tous les champs obligatoires.
                </div>
            </div>

            <button type="submit" class="ic-button ic-button--primary" style="width: 100%;">
                <%= __('i18n.views.manage.add_collectors') %>
            </button>
        </form>

        <!-- Sketch section -->
        <div id="hit-sketch" class="ic-hidden" style="margin-top: 2rem;">
            <p style="text-align: center; color: var(--muted); margin-bottom: 1rem;">
                <%= __('i18n.views.manage.sketch') %>
            </p>
            <button id="hit-sketch-button" class="ic-button ic-button--secondary" style="width: 100%;">
                <%= __('i18n.views.manage.sketch.hit') %>
            </button>
            <div id="hit-sketch-success" class="ic-alert ic-alert--success ic-hidden" style="margin-top: 1rem;">
                <span>‚úì</span>
                <div><%= __('i18n.views.manage.sketch.hit.done') %></div>
            </div>
        </div>
    </div>

    <!-- PROGRESS CONTAINER -->
    <div id="progress-container" class="ic-container ic-hidden">
        <!-- TITLE (√† cacher quand r√©sultat affich√©) -->
        <div id="progress-loading" class="ic-text-center">
            <div class="ic-loader">
                <div class="ic-spinner ic-spinner--large"></div>
            </div>
            
            <h1 class="ic-header-title" style="margin-bottom: 0.5rem;">
                <%= __('i18n.views.manage.adding_collector') %>
            </h1>
            <p class="ic-header-subtitle" id="progress-subtitle">Collecte des donn√©es...</p>
        </div>
        
        <!-- PROGRESS BAR (√† cacher quand r√©sultat affich√©) -->
        <div id="progress-bar-section" class="ic-progress" style="margin-top: 2rem;">
            <div class="ic-progress-label">
                <span id="progress-text"></span>
            </div>
            <div class="ic-progress-bar" id="progress-bar-container">
                <div class="ic-progress-fill" id="progress-bar" style="width: 0%"></div>
            </div>
        </div>
        
        <!-- 2FA FORM -->
        <div id="send-2fa-container" hidden>
            <form id="send-2fa-form" style="margin-top: 2rem;">
                <div class="ic-form-group">
                    <label class="ic-label ic-label--required" id="send-2fa-instructions"></label>
                    <input 
                        type="text" 
                        name="code" 
                        class="ic-input" 
                        placeholder="<%= __('i18n.views.manage.2fa.placeholder') %>"
                    >
                </div>
                <button type="submit" class="ic-button ic-button--primary" style="width: 100%;">
                    <%= __('i18n.views.manage.continue') %>
                </button>
            </form>
        </div>
        
        <!-- RESPONSE SUCCESS -->
        <div id="progress-response-success" class="progress-response" hidden>
            <div class="ic-text-center">
                <div style="font-size: 4rem; margin-bottom: 1rem; color: var(--success);">‚úì</div>
                <h1 class="ic-header-title" style="color: var(--success); margin-bottom: 0.5rem;">
                    Collection Complete
                </h1>
                <div class="ic-badge ic-badge--stable" style="margin-bottom: 1rem;">Successfully collected</div>
                <p class="ic-header-subtitle">Status: Complete</p>
                <button class="ic-button ic-button--primary" onclick="closeIframe()" style="margin-top: 2rem; width: 100%;">
                    Close
                </button>
            </div>
        </div>
        
        <!-- RESPONSE UNKNOWN -->
        <div id="progress-response-unknown" class="progress-response" hidden>
            <div class="ic-text-center">
                <div style="font-size: 4rem; margin-bottom: 1rem; color: var(--warning);">‚è±</div>
                <h1 class="ic-header-title" style="color: var(--warning); margin-bottom: 0.5rem;">
                    <%= __('i18n.views.manage.unknown') %>
                </h1>
                <p class="ic-header-subtitle">La collecte est en cours...</p>
                <button class="ic-button ic-button--primary" onclick="closeIframe()" style="margin-top: 2rem; width: 100%;">
                    Close
                </button>
            </div>
        </div>
        
        <!-- RESPONSE ERROR -->
        <div id="progress-response-error" class="progress-response" hidden>
            <div class="ic-text-center">
                <div style="font-size: 4rem; margin-bottom: 1rem; color: var(--danger);">‚úï</div>
                <h1 class="ic-header-title" style="color: var(--danger); margin-bottom: 0.5rem;">
                    Collection Failed
                </h1>
                <p class="ic-header-subtitle" id="progress-response-error-text">Identifiant ou mot de passe incorrect</p>
                <p style="margin-top: 0.5rem; color: var(--muted);">Status: Failed</p>
                <button class="ic-button ic-button--primary" onclick="closeIframe()" style="margin-top: 2rem; width: 100%;">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- CANVAS CONTAINER (plein √©cran) -->
    <div id="canvas-container" class="ic-canvas-fullscreen" hidden>
        <!-- Barre de menu sup√©rieure -->
        <div class="ic-canvas-toolbar">
            <button class="ic-canvas-toolbar-back" onclick="showCompanies()">
                ‚Üê
            </button>
            <span class="ic-canvas-toolbar-icon">üîë</span>
            <span class="ic-canvas-toolbar-text">Connect your account below, and then confirm your connection.</span>
            <div class="ic-canvas-toolbar-actions">
                <button id="canvas-ok" class="ic-button ic-button--primary">
                    <span class="ic-canvas-btn-icon">‚úì</span>
                    <span class="ic-canvas-btn-text">I'm logged in</span>
                </button>
                <button id="canvas-cancel" class="ic-button ic-button--ghost">
                    <span class="ic-canvas-btn-icon">‚úï</span>
                    <span class="ic-canvas-btn-text">Cancel</span>
                </button>
            </div>
        </div>
        
        <!-- Canvas -->
        <div class="ic-canvas-content">
            <canvas id="canvas" width="1280" height="720"></canvas>
        </div>
    </div>

    <!-- REQUEST COLLECTOR CONTAINER -->
    <div id="feedback-container" class="ic-container ic-hidden">
        <a href="#" class="ic-back-button" onclick="event.preventDefault(); showCompanies();">
            <%= __('i18n.views.manage.return') %>
        </a>
        
        <div class="ic-header">
            <h1 class="ic-header-title">Request New Collector</h1>
        </div>
        
        <form id="feedback-form">
            <input type="text" name="type" value="new_collector" required hidden>
            
            <div class="ic-form-group">
                <label class="ic-label ic-label--required">Website URL</label>
                <input type="url" name="website_url" class="ic-input" placeholder="https://example.com" required>
            </div>
            
            <div class="ic-alert ic-alert--success ic-hidden" id="feedback-response-success">
                <span>‚úì</span>
                <div>Your request has been submitted successfully!</div>
            </div>
            
            <div class="ic-alert ic-alert--error ic-hidden" id="feedback-response-error">
                <span>‚úï</span>
                <div>An error occurred. Please try again.</div>
            </div>
            
            <button type="submit" class="ic-button ic-button--primary" style="width: 100%;">
                Submit Request
            </button>
        </form>
    </div>

    <!-- SCRIPT -->
    <script>
        const locale = "<%= locale %>";
    </script>
    <script src="/views/proto/datepicker/datepicker.js"></script>
    <script src="/views/ui/script.js"></script>
</body>
</html>